// Facebook Event Extractor Bookmarklet - With CORS Proxy Support
// Copy the line below (including javascript:) and save as a bookmark:

javascript:(function(){const modal=document.createElement('div');modal.id='event-extractor-modal';modal.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;max-height:80vh;overflow-y:auto;background:white;border:2px solid #8b4aff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10000;font-family:Arial,sans-serif;padding:20px;';const backdrop=document.createElement('div');backdrop.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;';function extractEventData(){const eventData={title:'',date:'',time:'',venue:'',description:'',organizer:'',url:window.location.href,extracted_at:new Date().toISOString()};try{const titleSelectors=['[data-testid="event-permalink-event-name"] h1','[data-testid="event-permalink-event-name"]','h1[data-testid="event-permalink-event-name"]','.x1heor9g .x1qlqyl8','h1'];for(const selector of titleSelectors){const titleEl=document.querySelector(selector);if(titleEl&&titleEl.textContent.trim()){eventData.title=titleEl.textContent.trim();break;}}const dateTimeSelectors=['[data-testid="event-permalink-details"] span','.x1i10hfl time','time','.event-date-time','.date-time-info'];let dateTimeText='';for(const selector of dateTimeSelectors){const elements=document.querySelectorAll(selector);for(const el of elements){const text=el.textContent.trim();if(text&&(text.includes('202')||text.includes('AM')||text.includes('PM'))){dateTimeText+=text+' ';}}if(dateTimeText)break;}const datePattern=/(\w+day,?\s+\w+\s+\d{1,2},?\s+\d{4})/i;const timePattern=/(\d{1,2}:\d{2}\s*(?:AM|PM))/i;const dateMatch=dateTimeText.match(datePattern);const timeMatch=dateTimeText.match(timePattern);if(dateMatch)eventData.date=dateMatch[1];if(timeMatch)eventData.time=timeMatch[1];const locationSelectors=['[data-testid="event-permalink-details"] a[href*="maps"]','.event-location','.venue-name','a[href*="maps.google"]','a[href*="facebook.com/pages"]'];for(const selector of locationSelectors){const locationEl=document.querySelector(selector);if(locationEl&&locationEl.textContent.trim()){eventData.venue=locationEl.textContent.trim();break;}}const organizerSelectors=['[data-testid="event-permalink-organizer"] a','.event-organizer a','.hosted-by a','a[role="link"][href*="/events"]'];for(const selector of organizerSelectors){const organizerEl=document.querySelector(selector);if(organizerEl&&organizerEl.textContent.trim()){eventData.organizer=organizerEl.textContent.trim();break;}}const descSelectors=['[data-testid="event-permalink-description"]','.event-description','.description-text'];for(const selector of descSelectors){const descEl=document.querySelector(selector);if(descEl&&descEl.textContent.trim()){eventData.description=descEl.textContent.trim().substring(0,300);break;}}}catch(error){console.error('Error extracting event data:',error);}return eventData;}function detectGenre(eventData){const content=(eventData.title+' '+eventData.description+' '+eventData.organizer).toLowerCase();const genreKeywords={'house':['house','deep house','tech house','progressive house'],'drum-and-bass':['drum and bass','dnb','liquid','neurofunk'],'ukg':['uk garage','garage','ukg','2-step'],'dubstep':['dubstep','bass music','riddim','future bass'],'trance':['trance','progressive trance','uplifting','psytrance'],'techno':['techno','minimal','industrial','detroit techno']};for(const [genre,keywords] of Object.entries(genreKeywords)){if(keywords.some(keyword=>content.includes(keyword))){return genre;}}return 'other';}const eventData=extractEventData();const detectedGenre=detectGenre(eventData);const jsonData={source:'facebook_bookmarklet',event_title:eventData.title,event_date:eventData.date,event_time:eventData.time,venue_name:eventData.venue,promoter:eventData.organizer,genre:detectedGenre,description:eventData.description,ticket_url:eventData.url,extracted_at:eventData.extracted_at};modal.innerHTML=`<div style="border-bottom: 2px solid #8b4aff; padding-bottom: 15px; margin-bottom: 20px;"><h2 style="color: #8b4aff; margin: 0; font-size: 20px;">ğŸµ Facebook Event Extractor</h2></div><div style="margin-bottom: 20px;"><h3 style="color: #333; margin-bottom: 10px;">ğŸ“Š Extracted Event Data:</h3><div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;"><div style="margin-bottom: 8px;"><strong>Title:</strong> ${eventData.title||'Not found'}</div><div style="margin-bottom: 8px;"><strong>Date:</strong> ${eventData.date||'Not found'}</div><div style="margin-bottom: 8px;"><strong>Time:</strong> ${eventData.time||'Not found'}</div><div style="margin-bottom: 8px;"><strong>Venue:</strong> ${eventData.venue||'Not found'}</div><div style="margin-bottom: 8px;"><strong>Organizer:</strong> ${eventData.organizer||'Not found'}</div><div style="margin-bottom: 8px;"><strong>Detected Genre:</strong> <span style="background: #8b4aff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${detectedGenre}</span></div><div style="margin-bottom: 8px;"><strong>URL:</strong> <a href="${eventData.url}" target="_blank" style="color: #8b4aff;">Event Link</a></div></div>${eventData.description?`<div style="margin-bottom: 15px;"><strong>Description Preview:</strong><div style="background: #f0f0f0; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 100px; overflow-y: auto;">${eventData.description}...</div></div>`:''}</div><div style="margin-bottom: 20px;"><h3 style="color: #333; margin-bottom: 10px;">ğŸ“§ Send Options:</h3><textarea id="json-output" style="width: 100%; height: 120px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;" readonly>${JSON.stringify(jsonData,null,2)}</textarea></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button id="copy-json" style="background: #8b4aff; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“‹ Copy Data</button><button id="send-direct" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“¤ Direct Send</button><button id="send-proxy" style="background: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸŒ Proxy Send</button><button id="close-modal" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">âŒ Close</button></div><div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 12px;">ğŸ’¡ <strong>Send Options:</strong><br><strong>Direct:</strong> Normal send (may fail due to CORS)<br><strong>Proxy:</strong> Use CORS proxy server (run: node cors-proxy-server.js)<br><strong>Copy:</strong> Manual paste into admin system</div>`;const copyBtn=modal.querySelector('#copy-json');const sendDirectBtn=modal.querySelector('#send-direct');const sendProxyBtn=modal.querySelector('#send-proxy');const closeBtn=modal.querySelector('#close-modal');const jsonOutput=modal.querySelector('#json-output');copyBtn.addEventListener('click',()=>{jsonOutput.select();document.execCommand('copy');copyBtn.textContent='âœ… Copied!';setTimeout(()=>copyBtn.textContent='ğŸ“‹ Copy Data',2000);});sendDirectBtn.addEventListener('click',async()=>{await sendToSystem('http://localhost:3001/api/events/import-from-email',sendDirectBtn,'ğŸ“¤ Direct Send');});sendProxyBtn.addEventListener('click',async()=>{await sendToSystem('http://localhost:8080/proxy',sendProxyBtn,'ğŸŒ Proxy Send');});async function sendToSystem(url,button,originalText){try{button.textContent='ğŸ“¤ Sending...';const response=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:jsonOutput.value});if(response.ok){button.textContent='âœ… Sent!';button.style.background='#28a745';}else{button.textContent='âŒ Error';button.style.background='#dc3545';}setTimeout(()=>{button.textContent=originalText;button.style.background='';},3000);}catch(error){console.error('Error sending data:',error);button.textContent='âŒ CORS Error';button.style.background='#dc3545';setTimeout(()=>{button.textContent=originalText;button.style.background='';},3000);}}function closeModal(){document.body.removeChild(backdrop);document.body.removeChild(modal);}closeBtn.addEventListener('click',closeModal);backdrop.addEventListener('click',closeModal);document.body.appendChild(backdrop);document.body.appendChild(modal);})();